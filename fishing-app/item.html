<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NZ Marlin & Tuna Fishing Predictor - Production</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <meta name="description" content="Real-time fishing predictions for New Zealand waters - Bay of Islands to North Cape">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1e3c72">
    <style>
        :root {
            --primary-color: #1e3c72;
            --secondary-color: #2a5298;
            --accent-color: #00a8cc;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: rgba(255, 255, 255, 0.95);
            --dark-bg: rgba(0, 0, 0, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: var(--dark-bg);
            color: white;
            padding: 1rem;
            backdrop-filter: blur(20px);
            border-bottom: 2px solid var(--accent-color);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .user-info.logged-in {
            display: flex;
        }

        .auth-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .auth-buttons.hidden {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-color), #0077be);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            background: linear-gradient(135deg, #0077be, #005a8b);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 119, 190, 0.3);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--accent-color);
        }

        .main-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: calc(100vh - 80px);
            gap: 1rem;
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .sidebar {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 1.5rem;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .map-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .control-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .control-section:last-child {
            border-bottom: none;
        }

        .control-section h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .conditions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .condition-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .condition-card.excellent {
            border-color: var(--success-color);
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
        }

        .condition-card.good {
            border-color: var(--warning-color);
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        }

        .condition-card.poor {
            border-color: var(--danger-color);
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        }

        .condition-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .condition-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 168, 204, 0.1);
        }

        .alerts {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid var(--warning-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .alert-priority {
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .priority-high {
            background: var(--danger-color);
            color: white;
        }

        .priority-medium {
            background: var(--warning-color);
            color: black;
        }

        .fishing-log {
            max-height: 250px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
        }

        .log-entry {
            background: white;
            border-radius: 6px;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
            border-left: 4px solid var(--accent-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .log-date {
            font-size: 0.8rem;
            color: #666;
            font-weight: bold;
        }

        .log-details {
            margin-top: 0.3rem;
            font-size: 0.9rem;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .legend h4 {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--dark-bg);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            z-index: 10000;
            backdrop-filter: blur(20px);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .mobile-toggle {
            display: none;
            position: fixed;
            top: 90px;
            left: 20px;
            z-index: 1000;
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.2rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            font-weight: 600;
            max-width: 300px;
            animation: slideInRight 0.3s ease;
        }

        .notification.success {
            background: var(--success-color);
            color: white;
        }

        .notification.error {
            background: var(--danger-color);
            color: white;
        }

        .notification.info {
            background: var(--accent-color);
            color: white;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .sidebar {
                position: fixed;
                top: 80px;
                left: -370px;
                height: calc(100vh - 80px);
                width: 350px;
                z-index: 1001;
                transition: left 0.3s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .mobile-toggle {
                display: block;
            }

            .map-container {
                height: calc(100vh - 140px);
            }

            .header-content {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .conditions-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">🐟 NZ Fishing Predictor</div>
            <div class="user-menu">
                <div class="user-info" id="userInfo">
                    <span id="userName">Guest</span>
                    <button class="btn btn-small btn-outline" onclick="logout()">Logout</button>
                </div>
                <div class="auth-buttons" id="authButtons">
                    <button class="btn btn-small btn-outline" onclick="showModal('loginModal')">Login</button>
                    <button class="btn btn-small" onclick="showModal('registerModal')">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <button class="mobile-toggle" onclick="toggleSidebar()">☰</button>

    <div class="main-container">
        <div class="sidebar" id="sidebar">
            <!-- Real-time Statistics -->
            <div class="control-section">
                <h3>📊 Live Stats</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCatches">--</div>
                        <div class="stat-label">Catches Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeAnglers">--</div>
                        <div class="stat-label">Active Anglers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgWeight">--</div>
                        <div class="stat-label">Avg Weight (kg)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="bestHotspot">--</div>
                        <div class="stat-label">Top Hotspot</div>
                    </div>
                </div>
            </div>

            <!-- Current Conditions -->
            <div class="control-section">
                <h3>🌊 Current Conditions</h3>
                <div class="conditions-grid">
                    <div class="condition-card" id="sstCard">
                        <div class="condition-value" id="sstValue">Loading...</div>
                        <div class="condition-label">Sea Surface Temp</div>
                    </div>
                    <div class="condition-card" id="currentCard">
                        <div class="condition-value" id="currentValue">Loading...</div>
                        <div class="condition-label">Current Speed</div>
                    </div>
                    <div class="condition-card" id="chlorophyllCard">
                        <div class="condition-value" id="chlorophyllValue">Loading...</div>
                        <div class="condition-label">Chlorophyll-a</div>
                    </div>
                    <div class="condition-card" id="windCard">
                        <div class="condition-value" id="windValue">Loading...</div>
                        <div class="condition-label">Wind Speed</div>
                    </div>
                </div>
                <div id="conditionsSummary" class="condition-summary"></div>
            </div>

            <!-- Fishing Alerts -->
            <div class="control-section">
                <h3>🚨 Live Alerts</h3>
                <div class="alerts" id="alerts">
                    <div class="alert-item">
                        <span>⏳</span>
                        <span>Loading real-time alerts...</span>
                    </div>
                </div>
            </div>

            <!-- Log Catch -->
            <div class="control-section">
                <h3>📝 Log Your Catch</h3>
                <form id="catchForm" onsubmit="logCatch(event)">
                    <div class="form-group">
                        <label>Fish Species *</label>
                        <select id="species" required>
                            <option value="">Select species</option>
                            <option value="Blue Marlin">Blue Marlin</option>
                            <option value="Striped Marlin">Striped Marlin</option>
                            <option value="Yellowfin Tuna">Yellowfin Tuna</option>
                            <option value="Bigeye Tuna">Bigeye Tuna</option>
                            <option value="Albacore Tuna">Albacore Tuna</option>
                            <option value="Mako Shark">Mako Shark</option>
                            <option value="Kingfish">Kingfish</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Weight (kg) *</label>
                        <input type="number" id="weight" step="0.1" min="0.1" required>
                    </div>
                    <div class="form-group">
                        <label>Length (cm)</label>
                        <input type="number" id="length" step="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>Gear Used *</label>
                        <select id="gear" required>
                            <option value="">Select gear</option>
                            <option value="Trolling Lures">Trolling Lures</option>
                            <option value="Live Bait">Live Bait</option>
                            <option value="Dead Bait">Dead Bait</option>
                            <option value="Jigging">Jigging</option>
                            <option value="Fly Fishing">Fly Fishing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Depth (m)</label>
                        <input type="number" id="depth" step="1" min="0">
                    </div>
                    <div class="form-group">
                        <label>Location Notes</label>
                        <textarea id="locationNotes" rows="2" placeholder="e.g., 2nm NE of King Bank, near temperature break"></textarea>
                    </div>
                    <button type="submit" class="btn" id="logCatchBtn">Log Catch</button>
                </form>
            </div>

            <!-- Map Controls -->
            <div class="control-section">
                <h3>🗺️ Map Layers</h3>
                <button class="btn" onclick="toggleLayer('temperature')" id="tempBtn">Temperature Layer</button>
                <button class="btn" onclick="toggleLayer('current')" id="currentBtn">Current Layer</button>
                <button class="btn" onclick="toggleLayer('chlorophyll')" id="chlorBtn">Chlorophyll Layer</button>
                <button class="btn" onclick="toggleLayer('predictions')" id="predBtn">Predictions</button>
                <button class="btn btn-outline" onclick="refreshData()" id="refreshBtn">🔄 Refresh Data</button>
            </div>

            <!-- Recent Activity -->
            <div class="control-section">
                <h3>🎣 Recent Activity</h3>
                <div class="fishing-log" id="fishingLog">
                    <div class="log-entry">
                        <div class="log-details" style="text-align: center; color: #666;">
                            Loading recent catches...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="legend">
                <h4>Fishing Probability</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #d73027;"></div>
                    <span>Excellent (80-100%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fc8d59;"></div>
                    <span>Good (60-80%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fee08b;"></div>
                    <span>Fair (40-60%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e0f3f8;"></div>
                    <span>Poor (20-40%)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Loading oceanographic data...</div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <span class="close" onclick="hideModal('loginModal')">&times;</span>
            <h3>Login</h3>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <span class="close" onclick="hideModal('registerModal')">&times;</span>
            <h3>Create Account</h3>
            <form id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="registerPassword" minlength="6" required>
                </div>
                <button type="submit" class="btn">Create Account</button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configuration
        const API_BASE = window.location.hostname === 'localhost' ? 
            'http://localhost:3000/api' : '/api';
        
        // Global variables
        let map;
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        let layers = {
            temperature: null,
            current: null,
            chlorophyll: null,
            predictions: null,
            catches: null
        };
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initializeMap();
            loadAllData();
            startRealTimeUpdates();
        });

        // Authentication
        function checkAuth() {
            if (authToken) {
                // Verify token validity
                fetch(`${API_BASE}/verify`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Invalid token');
                    }
                })
                .then(data => {
                    currentUser = data.user;
                    updateUIForLoggedInUser();
                })
                .catch(() => {
                    logout();
                });
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    updateUIForLoggedInUser();
                    hideModal('loginModal');
                    showNotification('Login successful!', 'success');
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                showNotification('Login failed. Please try again.', 'error');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    updateUIForLoggedInUser();
                    hideModal('registerModal');
                    showNotification('Account created successfully!', 'success');
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                showNotification('Registration failed. Please try again.', 'error');
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            updateUIForLoggedOutUser();
            showNotification('Logged out successfully', 'info');
        }

        function updateUIForLoggedInUser() {
            document.getElementById('userInfo').classList.add('logged-in');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('authButtons').classList.add('hidden');
            document.getElementById('logCatchBtn').disabled = false;
        }

        function updateUIForLoggedOutUser() {
            document.getElementById('userInfo').classList.remove('logged-in');
            document.getElementById('authButtons').classList.remove('hidden');
            document.getElementById('logCatchBtn').disabled = true;
            document.getElementById('logCatchBtn').textContent = 'Login Required';
        }

        // Map initialization
        function initializeMap() {
            map = L.map('map', {
                center: [-34.25, 173.25],
                zoom: 9,
                zoomControl: true
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            addFishingHotspots();
        }

        async function addFishingHotspots() {
            try {
                const response = await fetch(`${API_BASE}/hotspots`);
                const hotspots = await response.json();

                hotspots.forEach(hotspot => {
                    const icon = L.divIcon({
                        html: `<div style="background: #00a8cc; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3); font-size: 12px;">🏖️</div>`,
                        iconSize: [30, 30],
                        className: 'hotspot-marker'
                    });

                    L.marker([hotspot.latitude, hotspot.longitude], { icon })
                        .addTo(map)
                        .bindPopup(`
                            <div style="min-width: 200px;">
                                <strong>${hotspot.name}</strong><br>
                                <em>${hotspot.description}</em><br><br>
                                <strong>Target Species:</strong> ${hotspot.species_common}<br>
                                <strong>Success Rate:</strong> ${hotspot.avg_success_rate}%<br>
                                <strong>Recent Catches:</strong> ${hotspot.recent_catches || 0}<br>
                                ${hotspot.avg_weight ? `<strong>Avg Weight:</strong> ${hotspot.avg_weight.toFixed(1)}kg<br>` : ''}
                                <br>
                                <button onclick="planRoute(${hotspot.latitude}, ${hotspot.longitude})" class="btn btn-small" style="width: 100%; margin-top: 5px;">
                                    Plan Route
                                </button>
                            </div>
                        `);
                });
            } catch (error) {
                console.error('Failed to load hotspots:', error);
            }
        }

        // Data loading functions
        async function loadAllData() {
            showLoading(true);
            try {
                await Promise.all([
                    loadCurrentConditions(),
                    loadPredictions(),
                    loadRecentCatches(),
                    loadLiveStats(),
                    loadFishingAlerts()
                ]);
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Failed to load some data', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadCurrentConditions() {
            try {
                const response = await fetch(`${API_BASE}/conditions/current`);
                const conditions = await response.json();

                updateConditionsDisplay(conditions);
            } catch (error) {
                console.error('Failed to load conditions:', error);
                // Use fallback data
                const fallback = generateFallbackConditions();
                updateConditionsDisplay(fallback);
            }
        }

        function updateConditionsDisplay(conditions) {
            document.getElementById('sstValue').textContent = `${conditions.sea_temperature?.toFixed(1) || '--'}°C`;
            document.getElementById('currentValue').textContent = `${conditions.current_speed?.toFixed(1) || '--'} m/s`;
            document.getElementById('chlorophyllValue').textContent = `${conditions.chlorophyll?.toFixed(2) || '--'} mg/m³`;
            document.getElementById('windValue').textContent = `${Math.round(conditions.wind_speed) || '--'} kts`;

            // Update condition cards based on favorability
            const favorability = conditions.favorability || calculateFavorability(conditions);
            updateConditionCards(favorability);

            // Update summary
            const summary = document.getElementById('conditionsSummary');
            if (summary) {
                summary.innerHTML = `
                    <div style="text-align: center; padding: 0.5rem; background: ${getFavorabilityColor(favorability.rating)}; border-radius: 6px; color: white; font-weight: bold;">
                        ${favorability.rating.toUpperCase()} CONDITIONS (${favorability.score}/100)
                    </div>
                `;
            }
        }

        function updateConditionCards(favorability) {
            const cards = {
                sstCard: favorability.factors.temperature,
                currentCard: favorability.factors.current,
                chlorophyllCard: favorability.factors.chlorophyll,
                windCard: favorability.factors.wind
            };

            Object.entries(cards).forEach(([cardId, rating]) => {
                const card = document.getElementById(cardId);
                if (card) {
                    card.className = `condition-card ${rating}`;
                }
            });
        }

        async function loadPredictions() {
            try {
                const response = await fetch(`${API_BASE}/predictions?hours=12`);
                const predictions = await response.json();

                if (layers.predictions) {
                    map.removeLayer(layers.predictions);
                }

                layers.predictions = L.layerGroup();

                predictions.forEach(prediction => {
                    const color = getProbabilityColor(prediction.probability);
                    const radius = Math.max(2000, prediction.probability * 40);

                    L.circle([prediction.latitude, prediction.longitude], {
                        radius: radius,
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.6,
                        weight: 2,
                        className: 'prediction-circle'
                    }).bindPopup(`
                        <strong>${prediction.species} Prediction</strong><br>
                        Probability: <strong>${prediction.probability}%</strong><br>
                        ${prediction.conditions ? `
                            Temp: ${JSON.parse(prediction.conditions).sea_temperature?.toFixed(1)}°C<br>
                            Current: ${JSON.parse(prediction.conditions).current_speed?.toFixed(1)} m/s<br>
                        ` : ''}
                        <small>Updated: ${new Date(prediction.timestamp).toLocaleString()}</small>
                    `).addTo(layers.predictions);
                });

                map.addLayer(layers.predictions);
            } catch (error) {
                console.error('Failed to load predictions:', error);
            }
        }

        async function loadRecentCatches() {
            try {
                const response = await fetch(`${API_BASE}/catches/public?days=7&limit=20`);
                const catches = await response.json();

                displayRecentCatches(catches);
                addCatchMarkersToMap(catches);
            } catch (error) {
                console.error('Failed to load recent catches:', error);
                document.getElementById('fishingLog').innerHTML = `
                    <div class="log-entry">
                        <div class="log-details" style="text-align: center; color: #666;">
                            Unable to load recent catches
                        </div>
                    </div>
                `;
            }
        }

        function displayRecentCatches(catches) {
            const logContainer = document.getElementById('fishingLog');
            
            if (catches.length === 0) {
                logContainer.innerHTML = `
                    <div class="log-entry">
                        <div class="log-details" style="text-align: center; color: #666;">
                            No recent catches reported
                        </div>
                    </div>
                `;
                return;
            }

            logContainer.innerHTML = catches.slice(0, 5).map(catch_ => {
                const timeAgo = getTimeAgo(new Date(catch_.time_caught));
                return `
                    <div class="log-entry">
                        <div class="log-date">${timeAgo} - ${catch_.angler_name}</div>
                        <div class="log-details">
                            <strong>${catch_.species}</strong> - ${catch_.weight}kg
                            ${catch_.length ? ` (${catch_.length}cm)` : ''}
                            <br><em>${catch_.gear_type}</em>
                            ${catch_.notes ? `<br><small>"${catch_.notes}"</small>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addCatchMarkersToMap(catches) {
            if (layers.catches) {
                map.removeLayer(layers.catches);
            }

            layers.catches = L.layerGroup();

            const speciesIcons = {
                'Blue Marlin': '🗡️',
                'Striped Marlin': '🎯',
                'Yellowfin Tuna': '🟡',
                'Bigeye Tuna': '👁️',
                'Albacore Tuna': '⚪',
                'Mako Shark': '🦈',
                'Kingfish': '👑'
            };

            catches.forEach(catch_ => {
                const icon = L.divIcon({
                    html: `<div style="background: #28a745; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-size: 10px;">${speciesIcons[catch_.species] || '🐟'}</div>`,
                    iconSize: [20, 20],
                    className: 'catch-marker'
                });

                L.marker([catch_.latitude, catch_.longitude], { icon })
                    .bindPopup(`
                        <strong>${catch_.species}</strong><br>
                        Weight: ${catch_.weight}kg ${catch_.length ? `(${catch_.length}cm)` : ''}<br>
                        Gear: ${catch_.gear_type}<br>
                        Angler: ${catch_.angler_name}<br>
                        <small>${new Date(catch_.time_caught).toLocaleString()}</small>
                        ${catch_.notes ? `<br><em>"${catch_.notes}"</em>` : ''}
                    `)
                    .addTo(layers.catches);
            });

            map.addLayer(layers.catches);
        }

        async function loadLiveStats() {
            try {
                const response = await fetch(`${API_BASE}/stats?days=1`);
                const stats = await response.json();

                updateStatsDisplay(stats);
            } catch (error) {
                console.error('Failed to load stats:', error);
                // Show fallback stats
                document.getElementById('totalCatches').textContent = '--';
                document.getElementById('activeAnglers').textContent = '--';
                document.getElementById('avgWeight').textContent = '--';
                document.getElementById('bestHotspot').textContent = '--';
            }
        }

        function updateStatsDisplay(stats) {
            const totalCatches = stats.reduce((sum, stat) => sum + stat.total_catches, 0);
            const uniqueAnglers = new Set(stats.map(stat => stat.unique_anglers)).size;
            const avgWeight = stats.reduce((sum, stat) => sum + (stat.avg_weight * stat.total_catches), 0) / totalCatches || 0;
            
            // Find most popular species
            const topSpecies = stats.sort((a, b) => b.total_catches - a.total_catches)[0];

            document.getElementById('totalCatches').textContent = totalCatches;
            document.getElementById('activeAnglers').textContent = uniqueAnglers;
            document.getElementById('avgWeight').textContent = avgWeight ? avgWeight.toFixed(1) : '--';
            document.getElementById('bestHotspot').textContent = topSpecies ? topSpecies.species.split(' ')[0] : '--';
        }

        async function loadFishingAlerts() {
            try {
                const response = await fetch(`${API_BASE}/alerts`);
                const alerts = await response.json();

                displayAlerts(alerts);
            } catch (error) {
                console.error('Failed to load alerts:', error);
                document.getElementById('alerts').innerHTML = `
                    <div class="alert-item">
                        <span>⚠️</span>
                        <span>Unable to load current alerts</span>
                    </div>
                `;
            }
        }

        function displayAlerts(alerts) {
            const alertsContainer = document.getElementById('alerts');
            
            if (alerts.length === 0) {
                alertsContainer.innerHTML = `
                    <div class="alert-item">
                        <span>🔕</span>
                        <span>No active alerts at this time</span>
                    </div>
                `;
                return;
            }

            alertsContainer.innerHTML = alerts.map(alert => `
                <div class="alert-item">
                    <div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem;">
                            <span>${getAlertIcon(alert.type)}</span>
                            <span class="alert-priority priority-${alert.priority}">${alert.priority}</span>
                        </div>
                        <div><strong>${alert.title}</strong></div>
                        <div style="font-size: 0.9rem; margin-top: 0.2rem;">${alert.message}</div>
                        ${alert.location ? `
                            <button onclick="flyToLocation(${alert.location.lat}, ${alert.location.lng})" 
                                    style="margin-top: 0.5rem; padding: 0.3rem 0.8rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                View on Map
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Catch logging
        async function logCatch(event) {
            event.preventDefault();
            
            if (!authToken) {
                showNotification('Please login to log catches', 'error');
                return;
            }

            const formData = {
                species: document.getElementById('species').value,
                weight: parseFloat(document.getElementById('weight').value),
                length: document.getElementById('length').value ? parseFloat(document.getElementById('length').value) : null,
                gear_type: document.getElementById('gear').value,
                latitude: map.getCenter().lat,
                longitude: map.getCenter().lng,
                depth: document.getElementById('depth').value ? parseFloat(document.getElementById('depth').value) : null,
                time_caught: new Date().toISOString(),
                notes: document.getElementById('locationNotes').value
            };

            try {
                const response = await fetch(`${API_BASE}/catches`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('Catch logged successfully!', 'success');
                    document.getElementById('catchForm').reset();
                    
                    // Refresh data to show new catch
                    await loadRecentCatches();
                    await loadLiveStats();
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                console.error('Failed to log catch:', error);
                showNotification('Failed to log catch. Please try again.', 'error');
            }
        }

        // Layer management
        function toggleLayer(layerType) {
            const layer = layers[layerType];
            const button = document.getElementById(`${layerType === 'predictions' ? 'pred' : layerType === 'temperature' ? 'temp' : layerType === 'chlorophyll' ? 'chlor' : layerType}Btn`);
            
            if (layer) {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                    if (button) button.textContent = button.textContent.replace('Hide', 'Show');
                } else {
                    map.addLayer(layer);
                    if (button) button.textContent = button.textContent.replace('Show', 'Hide');
                }
            } else {
                // Load layer if not loaded yet
                switch (layerType) {
                    case 'temperature':
                        loadTemperatureLayer();
                        break;
                    case 'current':
                        loadCurrentLayer();
                        break;
                    case 'chlorophyll':
                        loadChlorophyllLayer();
                        break;
                }
            }
        }

        async function loadTemperatureLayer() {
            try {
                const bounds = map.getBounds();
                const boundsStr = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
                
                const response = await fetch(`${API_BASE}/conditions/grid?bounds=${boundsStr}`);
                const gridData = await response.json();

                if (layers.temperature) {
                    map.removeLayer(layers.temperature);
                }

                layers.temperature = L.layerGroup();

                gridData.forEach(point => {
                    if (point.sea_temperature) {
                        const color = getTemperatureColor(point.sea_temperature);
                        
                        L.circle([point.latitude, point.longitude], {
                            radius: 1500,
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.6,
                            weight: 0
                        }).bindPopup(`Temperature: ${point.sea_temperature.toFixed(1)}°C`)
                          .addTo(layers.temperature);
                    }
                });

                map.addLayer(layers.temperature);
            } catch (error) {
                console.error('Failed to load temperature layer:', error);
            }
        }

        // Utility functions
        function generateFallbackConditions() {
            return {
                sea_temperature: 20 + Math.random() * 6,
                current_speed: Math.random() * 1.2,
                chlorophyll: Math.random() * 0.5,
                wind_speed: 5 + Math.random() * 15,
                timestamp: new Date().toISOString(),
                favorability: {
                    score: 50 + Math.random() * 40,
                    rating: 'good',
                    factors: {
                        temperature: 'good',
                        current: 'good',
                        chlorophyll: 'good',
                        wind: 'good'
                    }
                }
            };
        }

        function calculateFavorability(conditions) {
            let score = 0;
            const factors = {};

            if (conditions.sea_temperature >= 20 && conditions.sea_temperature <= 24) {
                score += 25;
                factors.temperature = 'excellent';
            } else if (conditions.sea_temperature >= 18 && conditions.sea_temperature <= 26) {
                score += 15;
                factors.temperature = 'good';
            } else {
                factors.temperature = 'poor';
            }

            if (conditions.current_speed >= 0.5 && conditions.current_speed <= 1.2) {
                score += 20;
                factors.current = 'excellent';
            } else if (conditions.current_speed >= 0.3 && conditions.current_speed <= 1.5) {
                score += 10;
                factors.current = 'good';
            } else {
                factors.current = 'poor';
            }

            if (conditions.chlorophyll >= 0.1 && conditions.chlorophyll <= 0.4) {
                score += 20;
                factors.chlorophyll = 'excellent';
            } else if (conditions.chlorophyll >= 0.05 && conditions.chlorophyll <= 0.6) {
                score += 10;
                factors.chlorophyll = 'good';
            } else {
                factors.chlorophyll = 'poor';
            }

            if (conditions.wind_speed <= 15) {
                score += 15;
                factors.wind = 'excellent';
            } else if (conditions.wind_speed <= 20) {
                score += 8;
                factors.wind = 'good';
            } else {
                factors.wind = 'poor';
            }

            return {
                score: Math.min(100, Math.max(0, score)),
                rating: score >= 80 ? 'excellent' : score >= 60 ? 'good' : score >= 40 ? 'fair' : 'poor',
                factors
            };
        }

        function getTemperatureColor(temp) {
            if (temp < 18) return '#0571b0';
            if (temp < 20) return '#92c5de';
            if (temp < 22) return '#f7f7f7';
            if (temp < 24) return '#f4a582';
            if (temp < 26) return '#d73027';
            return '#8b0000';
        }

        function getProbabilityColor(probability) {
            if (probability >= 80) return '#d73027';
            if (probability >= 60) return '#fc8d59';
            if (probability >= 40) return '#fee08b';
            if (probability >= 20) return '#e0f3f8';
            return '#abd9e9';
        }

        function getFavorabilityColor(rating) {
            const colors = {
                excellent: '#28a745',
                good: '#ffc107',
                fair: '#fd7e14',
                poor: '#dc3545'
            };
            return colors[rating] || '#6c757d';
        }

        function getAlertIcon(type) {
            const icons = {
                hotspot: '🔥',
                environmental: '🌊',
                timing: '⏰',
                weather: '🌤️'
            };
            return icons[type] || '📢';
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const diffMs = now - timestamp;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays === 1) return 'Yesterday';
            return `${diffDays}d ago`;
        }

        function planRoute(lat, lng) {
            const userLocation = map.getCenter();
            const distance = calculateDistance(userLocation.lat, userLocation.lng, lat, lng);
            
            // Clear existing routes
            if (window.currentRoute) {
                map.removeLayer(window.currentRoute);
            }

            // Create route line
            window.currentRoute = L.polyline([
                [userLocation.lat, userLocation.lng],
                [lat, lng]
            ], {
                color: '#ff6b6b',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);
            
            // Fly to destination
            flyToLocation(lat, lng);
            
            showNotification(`Route planned: ${distance.toFixed(1)} nautical miles`, 'info');
        }

        function flyToLocation(lat, lng) {
            map.flyTo([lat, lng], 11, { duration: 1.5 });
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3440.065; // Earth radius in nautical miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function refreshData() {
            const button = document.getElementById('refreshBtn');
            const originalText = button.textContent;
            button.textContent = '⏳ Refreshing...';
            button.disabled = true;

            await loadAllData();

            button.textContent = originalText;
            button.disabled = false;
            showNotification('Data refreshed successfully!', 'success');
        }

        function startRealTimeUpdates() {
            // Update conditions every 5 minutes
            setInterval(loadCurrentConditions, 5 * 60 * 1000);
            
            // Update predictions every 15 minutes
            setInterval(loadPredictions, 15 * 60 * 1000);
            
            // Update catches and stats every 2 minutes
            setInterval(() => {
                loadRecentCatches();
                loadLiveStats();
            }, 2 * 60 * 1000);
            
            // Update alerts every minute
            setInterval(loadFishingAlerts, 60 * 1000);
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // UI functions
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // Service Worker Registration (for PWA features)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        }
    </script>
</body>
</html>